<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="assets/favicon.ico">

    <title>AtHome - Design</title>
    <!-- Bootstrap core CSS -->
    <link href="http://getbootstrap.com/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <link href="http://getbootstrap.com/assets/css/ie10-viewport-bug-workaround.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="assets/css/cover.css" rel="stylesheet">
    <!-- PDF viewer -->
    <script src="assets/js/pdfobject.min.js"></script>


    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <title>AtHome</title>
            </div>
            <div id="navbar" class="navbar-collapse collapse">
                <ul class="nav navbar-nav">
                    <li><a href="index.html"><span class="glyphicon glyphicon-home" aria-hidden="true"></span> Home</a></li>
                    <li class="dropdown">
                        <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="glyphicon glyphicon-list-alt" aria-hidden="true"></span> Requirements <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="requirements.html">Requirements</a></li>
                            <li><a href="userStories.html">User Stories</a></li>
                            <li><a href="processFlows.html">Process Flows</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="glyphicon glyphicon-book" aria-hidden="true"></span> Research <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="mockupTools.html">Mock-Up Tools</a></li>
                            <li><a href="technologies.html">Technologies</a></li>
                            <li><a href="videoapi.html">Video API's</a></li>
                            <li><a href="testingTools.html">Testing Tools</a></li>

                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="glyphicon glyphicon-user" aria-hidden="true"></span> HCI <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="mockups.html">Mock-Ups</a></li>
                            <li><a href="finalDelivery.html">Final Delivery</a></li>

                        </ul>
                    </li>
                    <li class="active"><a href="design.html"><span class="glyphicon glyphicon-qrcode" aria-hidden="true"></span> Design</a></li>
                    <li><a href="testing.html"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span> Testing</a></li>
                    <li><a href="evaluation.html"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span> Evaluation</a></li>
                    <li class="dropdown">
                        <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false"><span class="glyphicon glyphicon-briefcase" aria-hidden="true"></span> Management <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="manual.html">Manuals</a></li>
                            <li><a href="client.html">Client Feedback/Meetings</a></li>
                            <li><a href="gantt.html">Gantt Chart</a></li>
                            <li class="dropdown-header">Bi-Weekly Reports</li>
                            <li><a href="12_10.html">12 October</a></li>
                            <li><a href="28_10.html">28 October</a></li>
                            <li><a href="18_11.html">18 November</a></li>
                            <li><a href="02_12.html">02 December</a></li>
                            <li><a href="16_12.html">16 December</a></li>
                            <li><a href="27_01.html">27 January</a></li>
                            <li><a href="10_02.html">10 February</a></li>
                            <li><a href="27_02.html">27 February</a></li>
                            <li><a href="10_03.html">10 March</a></li>
                            <li><a href="24_03.html">24 March</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="https://github.com/omwbennett/athome" target="_blank"> <span class="glyphicon glyphicon-new-window" aria-hidden="true"></span> Git Repository</a>
                    </li>
                </ul>
            </div>
            <!--/.nav-collapse -->
        </div>
    </nav>

</head>

<body background="assets/banner.jpg">

    <div class="container">
        <div class="well col-md-offset-1 col-md-10">
            <h1>System Architecture </h1>
            <hr>
            <img class="center-block" src="assets/sysDiagram.png">

            <h4>Flask App</h4>
            <p> A standard Python Flask application. We have a set of endpoints for each demo site, those for the GP site are
                affixed with "2". The app queries a single database which stores patient records, schedule information and
                notifications. Flask has a set of design patterns that make it easy to implement functionality such as file
                uploading, cookies and database querying.
            </p>

            <h4>GP Demo Site</h4>
            <p> A set of html pages served by the flask web server which encompass the GP end of the consultation. HTML/CSS styling
                is designed to be as similar in terms of look and feel as an existing solution that GP's use. We made use
                of Bootstrap to easily style the website.
            </p>

            <h4>Care Home Demo Site</h4>
            <p> A set of html pages served by the flask web server which encompass the Care Home end of the consultation. HTML/CSS
                styling is designed to be similar to our Balsamiq mockups, but where changes seem appropriate they have been
                made. Again, we used Boostrap for this.
            </p>

            <h1>Database Structure</h4>
                <img class="center-block" src="assets/erDiagram.png">
                <hr>

                <p> As the aim of the application is to be demonstrated on a laptop to potential clients, a single shared database
                    for demonstration purposes is suitable. Furthermore, a single database makes it easy for data to be accessed
                    and updated between the two demo sites. For example, when a Care Home adds a patient, this is instantly
                    accessible by the GP site. In the future this database will not be needed as the system will make use
                    of existing patient database API's such as VISION.
                </p>
                <p>
                    The residents table is meant to imitate the patient information that would be available through the VISION API. A Care Home
                    would log in and book an appointment for a resident in the care home and residents can have multiple
                    appointments set up, therefore there is a one-to-many relationship. Each appointment is with a single
                    GP, however GP's can themselves have multiple appointments booked with various different residents/patients.
                    The schedule table holds every single appointment slot for all GP's, this is what populates the book
                    appointment page in the Care Home demo site. Prior to booking appointments, a Care Home has to fill out
                    a preliminary medical questionnaire for their resident, indicating the type of health issue the appointment
                    is for. To facilitate this booking process in the backend we created a separate Health_issues table for
                    this purpose. When appointments are made, a confirmation notification is generated for the user logged
                    into the Care Home demo site, these are generated then stored in the Notification table.
                </p>

                <h1>Development Tools</h1>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Function</th>
                            <th>Tools Used</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Communication</td>
                            <td>Skype for client meetings, Messenger for group discussions</td>
                        </tr>
                        <tr>
                            <td>File Storage</td>
                            <td>Google Drive for reports and group documents</td>
                        </tr>
                        <tr>
                            <td>UI Design</td>
                            <td>Balsamiq for UI Mockups</td>
                        </tr>
                        <tr>
                            <td>Version Control</td>
                            <td>GitHub</td>
                        </tr>
                        <tr>
                            <td>IDE</td>
                            <td>Basic text editors such as VSCode, Sublime for editing of HTML/CSS</td>
                        </tr>
                    </tbody>
                </table>

                <h1>Design Patterns</h1>
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Design Pattern</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Row Factory</td>
                            <td>To simplify working with SQLite, the row factory function is executed for every result obtained
                                from a DB query, converting the returned result into a Python dictionary.</td>
                        </tr>
                        <tr>
                            <td>Login Required Decorators</td>
                            <td>Applied to views which require a user to be logged in, the decorator checks the global request
                                object's user field and redirects if a user is not logged in.</td>
                        </tr>
                        <tr>
                            <td>Route Decorators</td>
                            <td>Used to bind a function to a URL, some of our views make use of variable rules to create simpler
                                URLs.
                            </td>
                        </tr>
                        <tr>
                            <td>Initial Schemas</td>
                            <td>On initiating the application, a database is created from our schema.sql file. This process is
                                done through a create_db() function.</td>
                        </tr>
                        <tr>
                            <td>Flask File Uploads</td>
                            <td>We follow a straightforward Flask file uploading pattern to let Care Homes upload profile pictures
                                of residents, this is done by directing our application to access the files dict in the request
                                object, then using save() to save the file to the filesystem.</td>
                        </tr>
                    </tbody>
                </table>



                <h1>Implementation Details of Key Functionalities</h1>
                <h3>Database Connections</h3>
                <p> Based off the common Flask database connection patterns we implemented several helper functions to achieve
                    this key functionality. On initialising the application, the database is initialised with <i>initdb()</i>.
                    This calls <i>get_db()</i> which in turn calls <i>connect_db()</i> This function makes use of the row
                    factory design pattern to return python dictionaries which are easier to manipulate. <i>initdb()</i>                    is then able to execute our <i>schema.sql</i> file which contains the blueprints to build our database
                    and populate it with initial values.
                </p>
                <pre><p>def connect_db():
    """Connects to the specific database."""
    rv = sqlite3.connect(app.config['DATABASE'])
    rv.row_factory = sqlite3.Row
    return rv

@app.cli.command()
def initdb():
    """Initializes the database."""
    db = get_db()
    with app.open_resource('schema.sql', mode='r') as f:
        db.cursor().executescript(f.read())
    db.commit()
    print('Initialized the database.')

def get_db():
    """Opens a new database connection if there is none yet for the current application context."""
    if not hasattr(g, 'sqlite_db'):
        g.sqlite_db = connect_db()
    return g.sqlite_db

def close_db(error):
    """Closes the database again at the end of the request."""
    if hasattr(g, 'sqlite_db'):
        g.sqlite_db.close()  
            </p></pre>

                <p>
                    Then we can easily query our database using our <i>query_db()</i> function, which executes a SQL query
                    contained in a string, then returns a dictionary object produced by the row factory.
                </p>
                <pre><p>def query_db(query, args=(), one=False):
    """Helper function to make db queries"""
    cur = get_db().execute(query, args)
    rv = cur.fetchall()
    cur.close()
    return (rv[0] if rv else None) if one else rv  </p></pre>



                <h3>File Uploads</h3>
                <p>To allow Care Homes to update their resident's profile pictures we needed to implement a file upload feature into our Flask App.
                    The first step was to set a list of allowed file extensions, to ensure for security reasons that certain types of files are not uploaded onto the fileserver.
                    We do this by setting a global var in our app, and creating a simple helper function to determine if a given filename should be allowed or not.
                </p>

                <pre><p>ALLOWED_EXTENSIONS = set(['png', 'jpeg', 'jpg', 'gif'])
                    
def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1] in ALLOWED_EXTENSIONS</p></pre>

                <p>After determining that a file is of the right type, we then implement the following block whenever our server receives a POST request from the addResident or editResident endpoints.
                    These are the two instances where a user would be able to upload a profile picture. The block is quite straightforward, 
                    we store the file from the request object, check if it is allowed, give the file a new name for storing into our fileserver, 
                    store the file in the FILE_UPLOADS folder and finally update our database with the correct image path for that resident.
                </p>
                <pre><p>file = request.files['file']
            if file and allowed_file(file.filename):
                name = (file.filename).split(".")
                name[0] = str(resident_id)
                filename = name[0] + "." + name[1]
                filename = secure_filename(filename)

                file.save(app.config['UPLOAD_FOLDER'] + '\\' + filename)
                
                ...

                db = get_db()
                db.execute(query, args)
                db.commit()</p></pre>




                <h3>OpenTOK API</h3>
                <p>Some description here.</p>
                <pre><p>Some code here.</p></pre>

        </div>
    </div>
    <!-- /container -->

    <!-- Bootstrap core JavaScript
================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
        window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')
    </script>
    <script src="http://getbootstrap.com/dist/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="http://getbootstrap.com/assets/js/ie10-viewport-bug-workaround.js"></script>
</body>

</html>